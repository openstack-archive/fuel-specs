..
 This work is licensed under a Creative Commons Attribution 3.0 Unported
 License.

 http://creativecommons.org/licenses/by/3.0/legalcode

================================
Deployment role as a Fuel plugin
================================

https://blueprints.launchpad.net/fuel/+spec/role-as-a-plugin

Cloud operators want to extend and change behavior of Fuel in order to
do that, Fuel should provide plugins mechanism.

Problem description
===================

Sometimes Fuel user wants to extend Fuel deployment with
customized or new role. Currently user changes the
code of Fuel services, fixes deployment scripts, adds
required packages and rebuilds the repositories.

The current approach causes a lot of problems:

* user has to support all the patches
* also he has to apply all the patches manually after Fuel upgrade

Proposed change
===============

List of terms
-------------

* `plugin` - archive which contains all required data, like
  repositories for ubuntu, centos, metadata file with description
  of plugin, deployment scripts, etc
* `fpb` or `fuel-plugin-builder` - is fuel plugin builder, command
  line tool which helps user to develop plugin
* `role` - entity in Fuel, which defines what deployment scripts
  will be applied to nodes, also it helps to define disk partitioning
  and networks for specific node

Requirements
------------

* user should be able to install plugin as a role, then
  assign it to the node and deploy
* plugin developer can change deployment and provisioning
  data, which Nailgun sends to Astute
* plugin can be uninstalled
* plugin developer in the most cases should know nothing
  about python/js/css/html
* plugin developer should have easy way to test his plugin
  (he shouldn't reinstall his master node again and again to
  test his plugin)

Plugins constraints
-------------------

For the current release we have the next constraints:

* plugin cannot change Fuel's business logic
* user will not be able to enable plugin on deployed environment
* plugin cannot change or add new bootstrap image
* plugin cannot change existing database schema
* plugins will work on openstack releases after 6.0 Fuel release,
  plugins will not work on 5.X openstack releases. This constraint
  is related to changes in MCollective plugins

Plugin archive structure changes
--------------------------------

This structure should be generated by `fpb` script.

.. code-block:: text

    .
    |-- deployment_scripts
    |   `-- deploy.sh
    |-- environment_config.yaml
    |-- LICENSE
    |-- metadata.yaml
    |-- pre_build_hook
    |-- README.md
    |-- repositories
    |   |-- centos
    |   |   `-- .gitkeep
    |   `-- ubuntu
    |       `-- .gitkeep
    `-- tasks.yaml


**metadata.yaml**


.. code-block:: yaml

    # Format of the plugin is going to be changed
    # as result we should increase the version
    # from 1.0.0 to 2.0.0
    package_version: '2.0.0'

**tasks.yaml**

.. code-block:: yaml

    TODO: describe format of tasks
    with conditions, with possibility
    to replace task and add task
    with the main deployment for new
    role

**environment_config.yaml**

.. code-block:: yaml

  TODO We should be able to recursively
  merge this yaml with release structure
  from openstack.yaml

Alternatives
------------

None

Data model impact
-----------------

**Plugins**

* `enabled` - add new field which tells if plugin is enabled for the
  new environment by default

REST API impact
---------------

None

Deployment scripts
------------------

In the current implementation plugin developer
can use only puppet deployment scripts to deploy
role (this constraint is related to Astute,
in the future release it might be changed with
Mistral)

* plugin developer should provide puppet scripts with all of
  the dependencies
* scripts should not break anything if they were
  run several times

User workflow
-------------

* user installs fuel plugin
  (as usually with `fuel plugins install fuel-plugin-name-1.0.0.fp`)
* after that plugin can be seen on Plugins page, the button for this
  page will be placed somewhere between Environments and Releases buttons
* each plugin on the page has checkbox, the checkbox represents a
  default state of the plugin for new environments, if checkbox is checked,
  when user creates environment, he can see all of the buttons which
  are related to plugin, e.g. in case of Contrail he can see new option
  in the list of network providers on Network tab in the wizard
* during the environment configuration user should select options which
  are related to the plugin, the information about the list of options
  and where they should be placed is described by plugin developer
* when user starts deployment, Nailgun parses tasks and depending on
  conditions sends them to Astute, the conditions are described for
  each task by plugin developer, example of condition
  "cluster:net_provider != 'contrail' ", if task doesn't have conditions,
  we always execute it


Nailgun implementation
----------------------

* Nailgun retrieves a list of enabled for system plugins
* the list is used to merge base releases data with data
  which provided by plugins
* also Nailgun generates a field with ids of plugins
  which are merged, and adds this field for each release
* with this data UI can create a release with specific plugins
* during the environment creation Nailgun creates releations
  between Cluster and Plugin models

UI implementation
-----------------

* separate page with a list of plugins


Plugins uninstallation
----------------------

TODO who should manage plugins? (Nailgun/PluginManager service)

* check is plugin is used in any environment
* if it's not used it should be deleted from db
* plugin should be deleted from file system

Process of plugin deletion should be done in background.

Plugins migration from old version to new version
-------------------------------------------------

TODO should be manual or automated process?

* for each task generate condition
* continue checkbox generation for v1 plugins
* step-by-step documentation how to migrate plugin
  from previous version to newer version

Nailgun hooks
-------------

Pluggable architecture should provide a way to change
deployment data, which Nailgun sends to task executor
(Astute).

TODO example

Upgrade impact
--------------

TODO add implementation details

In upgrade script we should check if plugins are compatible with the new
version of fuel, if they aren't compatible, upgrade script should show
the message with the list of incompatible plugins and it should fail
the upgrade. If user wants to perform upgrade, he should provide the
directory with new plugins, which will be updated during the upgrade,
or user should delete plugins which he doesn't use.

For example user's environment is working with plugin lbaas-1.0.0,
which is compatible with fuel 6.0, during the upgrade user sees
error:

::

   `lbaas-1.0.0` plugin is not compatible with newer Fuel
   version (6.1), download the plugins and add them in a
   single directory, and provide the directory with a
   parameter '--new-plugins'.

CRITICAL TODO: what should do with new plugin? How can we make
sure that new plugin does not break compatibility with old one?

For example we can introduce convention for versioning, in our
example user should download not 2.0.0 plugin, but 1.0.0. 1.0.2
etc, but it dramatically increase complexity for user.

Security impact
---------------

This feature has a huge security impact because the user will be able
to execute any command on slave nodes.
Security is included in acceptance criteria of plugins certification,
see `Plugins certification` section.

Notifications impact
--------------------

None

Other end user impact
---------------------

User should be able to disable or enable plugin for specific environment.

Performance Impact
------------------

**Deployment**

* there will not be any impacts if user doesn't have enabled plugins
* if user has enabled plugins for environment, there will be performance
  impact, the time of deployment will be increased, the increasing time
  depends on the way how plugin is written

**Nailgun**

* we assume that there will not be any notable performance impact, in hooks
  we will have to enable merging of custom attributes in case if plugin is
  enabled for environment, the list of the plugins can be gotten within a
  single database query

Other deployer impact
---------------------

Plugin developer will be able to execute pre/post deployment hooks for
the environment.

Changes which are required in astute:

* add several repositories (should be ready, testing is required)
* add posibility to rsync specific directories from master to slave
* add hooks execution before and after puppet run

Developer impact
----------------

Features design impacts:

* any new feature should be considered to be a plugin
* features should be designed to be extendable

Implementation
==============

Assignee(s)
-----------

Primary assignee:

* eli@mirantis.com - developer, feature lead

Other contributors:

* TODO

Work Items
----------

* Fuel plugin builder should generate basic structure for
  plugin with a role

* Nailgun - should provide ability to enable/disable plugins
  for specific environments

* Nailgun - should provide hooks to change deployment/provisioning
  data

* UI - enable/disable plugins

* Fuel CLI - list/enable/disable/configure plugins for environment

Dependencies
============

This feature depends on Granular deployment feature:

https://blueprints.launchpad.net/fuel/+spec/granular-deployment-based-on-tasks

Testing
=======

TODO: Example of the plugin which our QA team will be able to tests.

Documentation Impact
====================

* how to create a plugin
* how to test a plugin
* how to debug a plugin
* how to add a plugin in core repository and how to perform testing
* documentation for plugin user, where will be the information where to take
  a plugin
* how to install a plugin

References
==========

* Nailgun, Ceph as a plugin - https://review.openstack.org/#/c/123840/
* Meeting notes 23 Dec 2015 -
  https://etherpad.openstack.org/p/fuel-ui-pluggable-architecture
* Plugins specification from previous release - http://bit.ly/1whwP81
